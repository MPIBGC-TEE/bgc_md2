# this file provides some variables for testing.
from collections import namedtuple
from sympy import Symbol, Function
from pathlib import Path
import netCDF4 as nc
import json 
from functools import lru_cache

@lru_cache
def make_test_args(conf_dict,msh,mvs):
    TestArgs=namedtuple(
        "TestArgs",
        [
            "V_init",
            "par_dict",
            "func_dict",
            "mvs",
            "dvs",
            "svs",
            "epa_0",
            "epa_min",
            "epa_max",
            "epa_opt",
            "cpa",
            "lats",
            "lons",
            "start_date"
        ]
    )
    par_dict = {
        Symbol(k): v for k, v in
        {
            "beta_wood1": 0.25,
            "beta_wood2": 0.1,
            "beta_leaf": 0.4,
            "beta_root": 0.15,
            #       "beta_fruit": 0.1,
            "T_0": 2,
            "E": 4,
            "KM": 10,
            "r_C_litter1_rh": 0.0000000000275,
            "r_C_litter2_rh": 0.000000000228,
            "r_C_litter3_rh": 0.000000000143,
            "r_C_litter4_rh": 0.0000000000441,
            "r_C_litter5_rh": 0.000000000119,
            "r_C_litter6_rh": 0.000000000177,
            "r_C_som1_rh": 0.000000000223,
            "r_C_som2_rh": 0.000000000116,
            "r_C_som3_rh": 0.00000000281,
            "r_C_som4_rh": 0.00000000476,
            "r_C_wood1_2_C_wood3": 0.00000000134,
            "r_C_wood1_2_C_litter1": 0.0000234,
            "r_C_wood2_2_C_wood4": 0.0000148,
            "r_C_wood2_2_C_litter2": 0.00000154,
            "r_C_wood3_2_C_litter1": 0.0000169,
            "r_C_wood4_2_C_litter2": 0.0000000253,
            "r_C_leaf_2_C_litter3": 0.000000719,
            "r_C_leaf_2_C_litter5": 0.00000945,
            "r_C_root_2_C_litter4": 0.00000743,
            "r_C_root_2_C_litter6": 0.00000212,
            "r_C_fruit_2_C_litter3": 0.0000159,
            "r_C_fruit_2_C_litter5": 0.000000728,
            "r_C_litter1_2_C_som1": 0.00001,
            "r_C_litter1_2_C_som2": 0.00000143,
            "r_C_litter2_2_C_som2": 0.0000185,
            "r_C_litter2_2_C_som3": 0.00000635,
            "r_C_litter3_2_C_som1": 0.00000117,
            "r_C_litter3_2_C_som3": 0.00000000659,
            "r_C_litter4_2_C_som1": 0.00000446,
            "r_C_litter4_2_C_som2": 0.00000270,
            "r_C_litter5_2_C_som1": 0.0000288,
            "r_C_litter6_2_C_som2": 0.0000000747,
            "r_C_som1_2_C_som3": 0.00000363,

            "r_C_som2_2_C_som3": 0.0074,
            "r_C_som2_2_C_som4": 0.01278,
            "r_C_som3_2_C_som2": 0.02027,
            "r_C_som3_2_C_som4": 0.008349,
            "r_C_som4_2_C_som2": 0.018376,
            "r_C_som4_2_C_som3": 0.0,
    }.items()
}
    svs,dvs=msh.get_global_mean_vars(dataPath=Path(conf_dict["dataPath"]))
    svs_0=msh.Observables(*map(lambda v: v[0],svs))
    # create a start parameter tuple for the mcmc.
    epa_0 = msh.EstimatedParameters(
        beta_wood1=0.229,
        beta_wood2=0.27112,
        beta_leaf=0.2032,
        beta_root=0.1303,
        #   beta_fruit=0.1,
        T_0=1.865,
        E=3.246,
        KM=10.2,
        # r_C_leaf_rh=0,
        # r_C_wood_rh=0,
        # r_C_root_rh=0,
        r_C_litter1_rh=0.0012934,
        r_C_litter2_rh=0.59747,
        r_C_litter3_rh=0.01977,
        r_C_litter4_rh=0.0006258,
        r_C_litter5_rh=0.0000016211,
        r_C_litter6_rh=0.002435,
        r_C_som1_rh=0.00229726,
        r_C_som2_rh=0.0010939,
        r_C_som3_rh=0.0000455408,
        r_C_som4_rh=0.00028037,

        r_C_wood1_2_C_wood3=0.0107,
        r_C_wood1_2_C_litter1=0.066445,
        r_C_wood2_2_C_wood4=0.00063076,
        r_C_wood2_2_C_litter2=0.00168526,
        r_C_wood3_2_C_litter1=0.000007645231,
        r_C_wood4_2_C_litter2=0.000209176,
        r_C_leaf_2_C_litter3=0.0020595,
        r_C_leaf_2_C_litter5=0.0000250875,
        r_C_root_2_C_litter4=0.0000076896,
        r_C_root_2_C_litter6=0.000703836,
        r_C_fruit_2_C_litter3=0.00026986,
        r_C_fruit_2_C_litter5=0.00000463,
        r_C_litter1_2_C_som1=0.000001348,
        r_C_litter1_2_C_som2=0.0000192111,
        r_C_litter2_2_C_som2=0.00058924,
        r_C_litter2_2_C_som3=0.000645606,
        r_C_litter3_2_C_som1=0.000183481,
        r_C_litter3_2_C_som3=0.0001882826,
        r_C_litter4_2_C_som1=0.0001623,
        r_C_litter4_2_C_som2=0.0007858,
        r_C_litter5_2_C_som1=0.0000005513,
        r_C_litter6_2_C_som2=0.0829,
        r_C_som1_2_C_som3=0.000414588,
        r_C_som2_2_C_som3=0.005084,
        r_C_som2_2_C_som4=0.0000151975,
        r_C_som3_2_C_som2=0.0000509621,
        r_C_som3_2_C_som4=0.00000000396756,
        r_C_som4_2_C_som2=0.0004856444,
        r_C_som4_2_C_som3=0.00,

        C_wood1_0=0.1675,
        C_wood2_0=0.4386777,
        C_wood3_0=3.2784,
        C_wood4_0=0.0293,
        C_leaf_0=0.283,
        C_root_0=0.039,
        C_litter1_0=0.1177,
        C_litter2_0=0.0903,
        C_litter3_0=0.0243,
        C_litter4_0=0.01146,
        C_litter5_0=1.9707,
        C_som1_0=0.0479,
        C_som2_0=0.68511,
        C_som3_0=6.8025,
)
    #func_dict={
    #    Function(k):v
    #    for k,v in {
    #        'NPP':msh.make_npp_func(dvs),
    #        'xi':msh.make_xi_func(dvs,epa_0)
    #    }.items()
    #}
    epa_min = msh.EstimatedParameters(
        beta_wood1=0.01,
        beta_wood2=0.01,
        beta_leaf=0.01,
        beta_root=0.01,
        #   beta_fruit=0.1,
        T_0=1,
        E=1,
        KM=1,
        # r_C_leaf_rh=0,
        # r_C_wood_rh=0,
        # r_C_root_rh=0,

        r_C_litter1_rh=0.0012934/100,
        r_C_litter2_rh=0.59747/100,
        r_C_litter3_rh=0.01977/100,
        r_C_litter4_rh=0.0006258/100,
        r_C_litter5_rh=0.0000016211/100,
        r_C_litter6_rh=0.002435/100,
        r_C_som1_rh=0.00229726/100,
        r_C_som2_rh=0.0010939/100,
        r_C_som3_rh=0.0000455408/100,
        r_C_som4_rh=0.00028037/100,

        r_C_wood1_2_C_wood3=0.0107/100,
        r_C_wood1_2_C_litter1=0.066445/100,
        r_C_wood2_2_C_wood4=0.00063076/100,
        r_C_wood2_2_C_litter2=0.00168526/100,
        r_C_wood3_2_C_litter1=0.000007645231/100,
        r_C_wood4_2_C_litter2=0.000209176/100,
        r_C_leaf_2_C_litter3=0.0020595/100,
        r_C_leaf_2_C_litter5=0.0000250875/100,
        r_C_root_2_C_litter4=0.0000076896/100,
        r_C_root_2_C_litter6=0.000703836/100,
        r_C_fruit_2_C_litter3=0.00026986/100,
        r_C_fruit_2_C_litter5=0.00000463/100,
        r_C_litter1_2_C_som1=0.000001348/100,
        r_C_litter1_2_C_som2=0.0000192111/100,
        r_C_litter2_2_C_som2=0.00058924/100,
        r_C_litter2_2_C_som3=0.000645606/100,
        r_C_litter3_2_C_som1=0.000183481/100,
        r_C_litter3_2_C_som3=0.0001882826/100,
        r_C_litter4_2_C_som1=0.0001623/100,
        r_C_litter4_2_C_som2=0.0007858/100,
        r_C_litter5_2_C_som1=0.0000005513/100,
        r_C_litter6_2_C_som2=0.0829/100,
        r_C_som1_2_C_som3=0.000414588/100,
        r_C_som2_2_C_som3=0.005084/100,
        r_C_som2_2_C_som4=0.0000151975/100,
        r_C_som3_2_C_som2=0.0000509621/100,
        r_C_som3_2_C_som4=0.00000000396756/100,
        r_C_som4_2_C_som2=0.0004856444/100,
        r_C_som4_2_C_som3=0.00,


        C_wood1_0=0.016,
        C_wood2_0=0.0072,
        C_wood3_0=1,
        C_wood4_0=0.001,
        C_leaf_0=0.002,
        C_root_0=0.0013,
        C_litter1_0=0.0005,
        C_litter2_0=0.0015,
        C_litter3_0=0.0001,
        C_litter4_0=0.00002,
        C_litter5_0=0.1,
        C_som1_0=0.0001,
        C_som2_0=0.0001,
        C_som3_0=1,
)


    epa_max = msh.EstimatedParameters(
        beta_wood1=0.99,
        beta_wood2=0.99,
        beta_leaf=0.99,
        beta_root=0.99,
        #   beta_fruit=0.1,
        T_0=10,
        E=10,
        KM=100,

        r_C_litter1_rh=0.0012934*100,
        r_C_litter2_rh=0.59747*100,
        r_C_litter3_rh=0.01977*100,
        r_C_litter4_rh=0.0006258*100,
        r_C_litter5_rh=0.0000016211*100,
        r_C_litter6_rh=0.002435*100,
        r_C_som1_rh=0.00229726*100,
        r_C_som2_rh=0.0010939*100,
        r_C_som3_rh=0.0000455408*100,
        r_C_som4_rh=0.00028037*100,

        r_C_wood1_2_C_wood3=0.0107*100,
        r_C_wood1_2_C_litter1=0.066445*100,
        r_C_wood2_2_C_wood4=0.00063076*100,
        r_C_wood2_2_C_litter2=0.00168526*100,
        r_C_wood3_2_C_litter1=0.000007645231*100,
        r_C_wood4_2_C_litter2=0.000209176*100,
        r_C_leaf_2_C_litter3=0.0020595*100,
        r_C_leaf_2_C_litter5=0.0000250875*100,
        r_C_root_2_C_litter4=0.0000076896*100,
        r_C_root_2_C_litter6=0.000703836*100,
        r_C_fruit_2_C_litter3=0.00026986*100,
        r_C_fruit_2_C_litter5=0.00000463*100,
        r_C_litter1_2_C_som1=0.000001348*100,
        r_C_litter1_2_C_som2=0.0000192111*100,
        r_C_litter2_2_C_som2=0.00058924*100,
        r_C_litter2_2_C_som3=0.000645606*100,
        r_C_litter3_2_C_som1=0.000183481*100,
        r_C_litter3_2_C_som3=0.0001882826*100,
        r_C_litter4_2_C_som1=0.0001623*100,
        r_C_litter4_2_C_som2=0.0007858*100,
        r_C_litter5_2_C_som1=0.0000005513*100,
        r_C_litter6_2_C_som2=0.0829*100,
        r_C_som1_2_C_som3=0.000414588*100,
        r_C_som2_2_C_som3=0.005084*100,
        r_C_som2_2_C_som4=0.0000151975*100,
        r_C_som3_2_C_som2=0.0000509621*100,
        r_C_som3_2_C_som4=0.00000000396756*100,
        r_C_som4_2_C_som2=0.0004856444*100,
        r_C_som4_2_C_som3=0.00,

        C_wood1_0=5,
        C_wood2_0=5,
        C_wood3_0=10,
        C_wood4_0=5,
        C_leaf_0=5,
        C_root_0=5,
        C_litter1_0=1,
        C_litter2_0=1,
        C_litter3_0=1,
        C_litter4_0=1,
        C_litter5_0=17,
        C_som1_0=10,
        C_som2_0=10,
        C_som3_0=20,
    )
    epa_opt=epa_0 #temporarily

    cpa = msh.Constants(
        cVeg_0=svs_0.cVeg,
        cLitter_0=svs_0.cLitter,
        cSoil_0=svs_0.cSoil,
        npp_0=dvs.npp[0],  # * 86400,   # kg/m2/s kg/m2/day
    #    xi_0=dvs.xi[0],
        rh_0=svs_0.rh,  # * 86400,   # kg/m2/s kg/m2/day
        ra_0=svs_0.ra,  # * 86400,   # kg/m2/s kg/m2/day
        # r_C_root_litter_2_C_soil_slow=3.48692403486924e-5,
        # r_C_root_litter_2_C_soil_passive=1.74346201743462e-5,
        number_of_months=len(svs.rh)
        # number_of_months=120 # for testing and tuning mcmc
        # number_of_months=3840 # for testing and tuning mcmc
    )

    StartVector = msh.make_StartVector(mvs) 
    V_init = StartVector(
        C_wood1=epa_0.C_wood1_0,
        C_wood2=epa_0.C_wood2_0,
        C_wood3=epa_0.C_wood3_0,
        C_wood4= epa_0.C_wood4_0,
        C_leaf= epa_0.C_leaf_0,
        C_root= epa_0.C_root_0,
        C_fruit= cpa.cVeg_0 - (epa_0.C_wood1_0 + epa_0.C_wood2_0 + epa_0.C_wood3_0 + epa_0.C_wood4_0 + epa_0.C_leaf_0 + epa_0.C_root_0),
        C_litter1=epa_0.C_litter1_0,
        C_litter2= epa_0.C_litter2_0,
        C_litter3= epa_0.C_litter3_0,
        C_litter4=epa_0.C_litter4_0,
        C_litter5= epa_0.C_litter5_0,
        C_litter6= cpa.cLitter_0 - (epa_0.C_litter1_0 + epa_0.C_litter2_0 + epa_0.C_litter3_0 + epa_0.C_litter4_0 + epa_0.C_litter5_0),
        C_som1= epa_0.C_som1_0,
        C_som2= epa_0.C_som2_0,
        C_som3= epa_0.C_som3_0,
        C_som4= cpa.cSoil_0-(epa_0.C_som1_0 + epa_0.C_som2_0 + epa_0.C_som3_0),
        ra = cpa.ra_0,
        rh = cpa.rh_0    
        )
    ds=nc.Dataset(Path(conf_dict["dataPath"]).joinpath("OCN_S2_cLitter.nc"))    
    return TestArgs(
        V_init=V_init,
        par_dict=par_dict,
        func_dict=msh.make_func_dict(mvs,dvs,cpa,epa_opt),
        dvs=dvs,
        svs=svs,
        mvs=mvs,
        epa_0=epa_0,
        epa_min=epa_min,
        epa_max=epa_max,
        epa_opt=epa_opt,
        cpa=cpa,
        lats=ds.variables["latitude"][:],
        lons=ds.variables["longitude"][:],
        start_date=msh.start_date()
    )


